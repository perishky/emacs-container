Bootstrap: docker
From: ubuntu:24.04

%files
    ~/.ide/ /opt/ide/

%post
    EMACS_PATH="/opt/ide/emacs"
    PYTHON_PATH="/opt/ide/python"
    PYTHON_LIB_PATH="$PYTHON_PATH/lib"
    R_LIB_PATH="/opt/ide/R/library"

    # Update package lists
    apt-get update -y
    
    # Install essential packages
    apt-get install -y \
        wget \
        curl \
        git \
        build-essential \
        software-properties-common \
        apt-transport-https \
        ca-certificates \
        gnupg \
        lsb-release \
	libcurl4-openssl-dev \
	curl
    
    # Install Emacs
    add-apt-repository ppa:ubuntuhandbook1/emacs
    apt-get update -y
    apt-get install -y emacs emacs-common

    # Install Python and pip
    apt-get install -y \
        python3 \
        python3-pip \
        python3-dev \
        python3-venv
    
    # Create symlink for python command
    ln -sf /usr/bin/python3 /usr/bin/python
    
    # Install common Python packages
    pip3 install --prefix $PYTHON_PATH --upgrade pip
    pip3 install --prefix $PYTHON_PATH \
        numpy \
        pandas \
        matplotlib \
        scipy \
        jupyter \
        ipython \
        seaborn \
        scikit-learn \
        requests

    # install quarto
    QUARTO_VERSION=1.7.32
    QUARTO_URL=https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb
    curl -o quarto-linux-amd64.deb -L ${QUARTO_URL} && \
        DEBIAN_FRONTEND=noninteractive apt-get install -f -y ./quarto-linux-amd64.deb && \
        rm quarto-linux-amd64.deb

    # Add R repository key and repository
    wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter.asc | tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
    add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
    apt-get update -y
    
    # Install R
    apt-get install -y r-base r-base-dev

    # install R packages
    echo "data.table
    ggplot2
    ggrepel
    readxl
    remotes
    quarto
    readr
    dplyr
    tidyverse
    knitr" > r-pkgs.txt
    R -e "options(warn=2); install.packages(readLines('r-pkgs.txt'))"
    
    # Install additional useful packages
    apt-get install -y \
        vim \
        nano \
        htop \
        tree \
        less \
        man-db
    
    # Clean up to reduce image size
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export LC_ALL=C
    export PATH=/opt/ide/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    export RUNEMACS="emacs --init-directory /opt/ide/emacs"
    export PYTHON_PATH="/opt/ide/python"
    export PYTHON_LIB_PATH="$PYTHON_PATH/lib"
    export R_LIB_PATH="/opt/ide/R/library"

%runscript
    echo "Container with Emacs, R, and Python is ready!"
    echo "Available commands:"
    echo "  - emacs (text editor)"
    echo "  - python3 or python (Python interpreter)"
    echo "  - R (R statistical computing)"
    echo "  - jupyter (Jupyter notebook)"
    echo ""
    exec "$@"

%labels
    Author Matthew Suderman
    Version v1.0
    Description Container with Emacs, R, and Python

%help
    This container includes:
    - Emacs text editor
    - Python 3 with common data science packages (numpy, pandas, matplotlib, etc.)
    - R with tidyverse and other common packages
    - Jupyter notebook support
    
    Usage examples:
    apptainer run ide.sif
    apptainer exec ide.sif emacs
    apptainer exec ide.sif python3
    apptainer exec ide.sif R
    apptainer exec ide.sif jupyter notebook