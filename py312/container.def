Bootstrap: docker
From: ubuntu:24.04

%post
    BASE="/opt/ide"
    EMACS_DIR="$BASE/user-emacs"
    PYTHON_DIR="$BASE/user-python"

    mkdir -p $EMACS_DIR
    mkdir -p $PYTHON_DIR

    # install linux libraries
    apt-get update -y
    apt-get install -y \
        apt-transport-https \
        build-essential \
        ca-certificates \
        curl \
        git \
        gnupg \
        htop \
        less \
	libcairo2 \
	libcairo2-dev \
	libcurl4-openssl-dev \
	libdbus-glib-1-dev \
	libfontconfig1-dev \
        libfribidi-dev \
        libfreetype6-dev \
	libgirepository1.0-dev \
        libharfbuzz-dev \
        libjpeg-dev \
        libpng-dev \
        libssl-dev \
        libtiff5-dev \
        libxml2-dev \
        lsb-release \
        man-db \
	nscd \
	pandoc \
        pkg-config \
        software-properties-common \
	sudo \
        tree \
	virtualenv \
        vim \
        wget
	
    # install emacs
    add-apt-repository ppa:ubuntuhandbook1/emacs
    apt-get update -y
    apt-get install -y emacs emacs-common

    # install quarto
    QUARTO_VERSION=1.7.32
    QUARTO_URL=https://github.com/quarto-dev/quarto-cli/releases/download/v${QUARTO_VERSION}/quarto-${QUARTO_VERSION}-linux-amd64.deb
    curl -o quarto-linux-amd64.deb -L ${QUARTO_URL} && \
        DEBIAN_FRONTEND=noninteractive apt-get install -f -y ./quarto-linux-amd64.deb && \
        rm quarto-linux-amd64.deb

    # install python
    apt-get install -y \
        python3 \
        python3-pip \
        python3-dev \
        python3-venv 
    ln -sf /usr/bin/python3 /usr/bin/python

    python3 -m pip install --upgrade pip
    python3 -m pip install \
        jupyter \
        snakemake \
        jupytext \
        nibabel \
        scikit-image \
        itk \
        plotly \
        pooch \
        torch \
        torchvision \
        gensim \
        transformers \
        sentence-transformers \
        nltk \
        wordcloud
    
    # clean up
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export LC_ALL=C
    export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    export BASE="/opt/ide"
    export EMACS_DIR="$BASE/user-emacs"
    export PYTHONPATH="$BASE/user-python"
    ## needed for quarto
    export XDG_CACHE_HOME=/tmp/xdg_cache_home
    export XDG_DATA_HOME=/tmp/xdg_data_home
    export XDG_RUNTIME_DIR=/tmp/xdg_runtime_home
 
%runscript
    mkdir -p $EMACS_DIR
    mkdir -p $PYTHONPATH
    exec env HOME=$EMACS_DIR emacs --user="" -nw "$@"
    
%labels
    Author Matthew Suderman
    Version v1.0
    Description Container with Emacs and Python

%help
    This container includes:
    - Ubuntu 24.04
    - Emacs 30.1
    - Python 3.12

   Usage:
	apptainer run -B $BASE:/opt/ide -B $(pwd) py312.sif [path/to/files/to/edit]	
        ## Note: some systems may need the container to run with '--fakeroot'
